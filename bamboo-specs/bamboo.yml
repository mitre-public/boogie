---
version: 2
plan:
  project-key: TTFS
  key: SHIM
  name: TDP Boogie

branches:
  create: for-new-branch
  delete:
    after-deleted-days: 3
    after-inactive-days: 14
  link-to-jira: true

notifications:
  - recipients:
      - webhook:
          name: "Slack Build Webhook"
          url: "https://hooks.slack.com/services/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"
    events:
      - plan-status-changed

variables: !include 'variables.yml'

labels:
  - ttfs

stages:
  # Configure standard test and integration tests as part of the same stage but as different jobs so they can be run in parallel
  - Test: [ Gradle Standard Test, Gradle Integration Test ]
  - Push: [ Push Image Internal, Push Image External ]
  - Deploy:
      manual: true
      jobs: [ Deploy Internal Application ]

Gradle Standard Test:
  tasks:
    - checkout:
        force-clean-build: 'false'
    - script:
        file: ci-scripts/ci-build.sh
        # Export a location that doesn't exist so the locator doesn't attempt to parse a cycle of data that may be visible at the
        # default file location from the host machine
        environment: FILE_LOCATOR_PATH="/idont/exist"
  requirements:
    - system.name: rhizome[456]

Gradle Integration Test:
  tasks:
    - checkout:
        force-clean-build: 'false'
    - script:
        file: ci-scripts/ci-testIntegration.sh
        environment: FILE_LOCATOR_PATH="/idont/exist"
  requirements:
    - system.name: rhizome[456]

Push Image Internal:
  tasks:
    - script:
        file: bamboo-specs/ci-build-and-push-internal-artifactory.sh
        conditions: &only-run-main
          - variable:
              matches:
                bamboo.planRepository.branchDisplayName: 'main'
  requirements:
    - system.name: rhizome[\d]
    - Docker

Push Image External:
  tasks:
    - script:
        file: bamboo-specs/ci-build-and-push-external-artifactory.sh
        conditions: *only-run-main
  requirements:
    - system.name: rhizome[\d]
    - Docker

Deploy Internal Application:
  tasks:
    - script:
        file: bamboo-specs/deploy-service-internal-kubernetes.sh
        conditions: *only-run-main
  # Run the internal deployment job from a docker container which has kubectl installed
  # The standard bamboo agents don't have this available
  docker: centos:7

branch-overrides:
  - ^((?!main).)*$:
      notifications:
        - recipients:
            - responsible
            - watchers
            - committers
          events:
            - plan-failed